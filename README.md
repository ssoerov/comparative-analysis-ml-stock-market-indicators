# IMOEX Forecasting Stack (ГОСТ-style)

Исследовательский стенд посвящён только индексу IMOEX и строит почасовые прогнозы при строгом соблюдении принципа «без утечек». Библиотека повторно использует CatBoost, Random Forest, LSTM (базовую и с вниманием) и гибрид LSTM+SARIMAX+GARCH, а также выполняет цепной анализ и кластеризацию режима рынка с оформлением графиков по ГОСТ.

## Методология

- Прогнозируется приращение цены закрытия $r_t$ и условная волатильность $\sigma_t$:
  $$
  r_t = \mu + \beta^\top X_{t-1} + \varepsilon_t,\qquad
  \sigma_t^2 = \omega + \alpha \varepsilon_{t-1}^2 + \beta \sigma_{t-1}^2 + \gamma^\top X_{t-1}.
  $$
- Вектор факторов $X_{t-1}$ состоит только из лагов: Brent, USD/RUB, ключевая ставка, RSI(50), ATR(50) и собственные лаги цены.
- Все признаки строятся строго по истории; walk-forward разбиение и опциональное эмбарго защищают от утечек.
- Гибридная LSTM получает на вход прогноз SARIMAX и оценку $\sigma_t$ из GARCH, что позволяет адаптировать риск-профиль.

## Структура репозитория

```
cli.py                      # основной вход для запуска конвейера
tools/run_imoex_analysis.py # цепной анализ и кластеризация без обучения моделей
vkr_fast/                   # пакет с конфигами, фичами, моделями и отчётностью
data_input/                 # Brent / USD_RUB CSV
data_cache/                 # кэш MOEX-данных (IMOEX)
saved_models/               # сохранённые гибридные LSTM по фолдам (IMOEX)
```

Результаты всегда попадают в `outputs/`: метрики, отчёты по моделям, EDA, цепной анализ (`outputs/imoex_analysis/`), кластеризация (`outputs/clustering/`), графики и готовый `REPORT.md`.

## Запуск

```bash
python3 -m venv venv
. venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt

# 1) Основной конвейер (CatBoost + RF + LSTM + Hybrid + GARCH)
python cli.py --no-tf  # если нет GPU, уберите чтобы включить LSTM (по умолчанию они включены)

# 2) Дополнительный цепной анализ (если нужно отдельно от обучения)
python tools/run_imoex_analysis.py

# 3) Сборка итогового отчёта
python tools/build_report.py
```

Полезные ключи `cli.py`:

| Параметр | Назначение |
|----------|------------|
| `--outer-folds`, `--test-horizon` | настройка walk-forward оценки |
| `--exog-lags` | количество лагов экзогенных факторов (по умолчанию 24 часа) |
| `--use-garch --garch-spec` | включение/настройка GARCH |
| `--no-tf` / `--no-catboost` | отключение тяжёлых моделей при необходимости |

## Отчётность и визуализация

- `REPORT.md` — autogenerated, содержит метрики моделей, DM-тесты, цепной анализ, кластеризацию и примеры графиков (все рисунки оформлены с ГОСТ‑стилем шрифтов/сеток).
- `outputs/imoex_analysis/IMOEX_chain_growth_*.csv` — таблицы цепного прироста, цепного роста и относительного роста; `IMOEX_chain_growth.png` — агрегированная визуализация.
- `outputs/clustering/` — CSV с метками режимов, статистикой и переходами, а также графики `*_clusters_price.png` и `*_clusters_scatter.png`.

## Тестирование

Перед публикацией необходимо прогнать хотя бы один сценарий:

```bash
python cli.py --tickers IMOEX --outer-folds 3 --test-horizon 120
python tools/build_report.py
```

Скрипт записывает все метрики в `outputs/metrics.csv`, а полные таблицы — в `outputs/consolidated/`. Если меняли расчёт признаков или модели, дополнительно выполните `python tools/run_imoex_analysis.py` для пересоздания цепного анализа.

## Данные

- Период: 2023‑04‑03 — 2025‑04‑03, шаг 1 час.
- Источники: MOEX ISS API (IMOEX), Yahoo Finance (Brent и USD/RUB), официальный ряд ключевой ставки.
- Все данные хранятся в UTC; индикаторы RSI(50)/ATR(50) и лаги рассчитываются строго до момента $t$.
