# IMOEX Forecasting Stack 

Исследовательский стенд посвящён только индексу IMOEX и строит почасовые прогнозы при строгом соблюдении принципа «без утечек». Библиотека использует CatBoost, Random Forest, LSTM (базовую и с вниманием) и гибрид LSTM+SARIMAX+GARCH, а также выполняет цепной анализ и кластеризацию режимов с ГОСТ‑оформлением графиков.

## Методология

- Прогнозируется приращение цены закрытия $r_t$ и условная волатильность $\sigma_t$:
  $$
  r_t = \mu + \beta^\top X_{t-1} + \varepsilon_t,\qquad
  \sigma_t^2 = \omega + \alpha \varepsilon_{t-1}^2 + \beta \sigma_{t-1}^2 + \gamma^\top X_{t-1}.
  $$
- Вектор факторов $X_{t-1}$ состоит только из лагов: Brent, USD/RUB, RSI(50), ATR(50), OBV, MACD, CCI, ROC, Stoch, Williams %R, Bollinger/MA и собственные лаги цены (KeyRate убрана как нерелевантная для часовых данных).
- Все признаки строятся строго по истории; walk-forward разбиение и опциональное эмбарго защищают от утечек.
- Гибридная LSTM получает на вход прогноз SARIMAX и оценку $\sigma_t$ из GARCH, что позволяет адаптировать риск-профиль.
- Две целевые переменные: `dclose` (разность Close) и `logret` (логарифм отношения $Close_t / Close_{t-1}$).

## Структура репозитория

```
cli.py                       # основной вход для запуска конвейера (dclose/logret)
tools/
  build_report.py            # итоговый отчёт (REPORT_dclose.md / REPORT_logret.md)
  build_full_series.py       # графики по всему периоду для всех моделей
  build_master_table.py      # сводная master-таблица со всеми факторами/прогнозами
  consolidate_from_preds.py  # объединение метрик/экономики/DM по фолдам
  run_imoex_analysis.py      # цепной анализ и кластеризация без обучения моделей
vkr_fast/                    # пакет с конфигами, фичами, моделями и отчётностью
data_input/                  # Brent / USD_RUB CSV (UTC)
data_cache/                  # кэш MOEX-данных (IMOEX)
saved_models/                # сохранённые гибридные LSTM по фолдам (IMOEX)
outputs/                     # артефакты для целевого dclose
outputs_logret/              # артефакты для целевого logret
```

### Что лежит в `outputs/` и `outputs_logret/`

- `preds/IMOEX_f{fold}.csv` — прогнозный горизонт (12×72ч) для каждого фолда.
- `full_preds/IMOEX_f{fold}.csv` — полные прогнозы по всей временной оси (CatBoost, LSTM_att, Hybrid, SARIMAX) + `y_true`.
- `reports/` — графики прогноза на горизонте, тесты стационарности, важность фичей.
- `reports_full/` — графики «факт vs модель» по всему периоду для каждого фолда/модели.
- `consolidated/*.csv` — объединённые метрики/экономика/DM-тесты по всем фолдам.
- `imoex_analysis/` — цепной/базисный анализ ряда и STL‑декомпозиция.
- `clustering/` — метки кластеров режимов, статистика, графики, матрица переходов.
- `master_table.csv` (в `outputs/`) — сводная таблица: время, факторы и индикаторы, целевые `y_dclose` и `y_logret`, цепные/базисные индексы, кластеры, и ВСЕ прогнозы всех моделей/фолдов для обоих таргетов.

Артефакты для `logret` дублируются в `outputs_logret/` с теми же структурами и именованием колонок `_logret_f{fold}`.

## Запуск

```bash
python3 -m venv venv
. venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt

# 1) Основной конвейер (CatBoost + RF + LSTM + Hybrid + GARCH)
python cli.py --no-tf  # если нет GPU, уберите чтобы включить LSTM (по умолчанию они включены)

# 2) Дополнительный цепной анализ (если нужно отдельно от обучения)
python tools/run_imoex_analysis.py

# 3) Сборка итогового отчёта
python tools/build_report.py
# Сборка master-таблицы (включает прогнозы обеих целевых)
python tools/build_master_table.py --out-dir outputs --dest outputs/master_table.csv
```

Полезные ключи `cli.py`:

| Параметр | Назначение |
|----------|------------|
| `--outer-folds`, `--test-horizon` | настройка walk-forward оценки |
| `--exog-lags` | количество лагов экзогенных факторов (по умолчанию 24 часа) |
| `--use-garch --garch-spec` | включение/настройка GARCH |
| `--no-tf` / `--no-catboost` | отключение тяжёлых моделей при необходимости |

## Отчётность и визуализация

- `REPORT.md` — autogenerated, содержит метрики моделей, DM-тесты, цепной анализ, кластеризацию и примеры графиков (все рисунки оформлены с ГОСТ‑стилем шрифтов/сеток).
- `outputs/imoex_analysis/IMOEX_chain_growth_*.csv` — таблицы цепного прироста, цепного роста и относительного роста; `IMOEX_chain_growth.png` — агрегированная визуализация.
- `outputs/clustering/` — CSV с метками режимов, статистикой и переходами, а также графики `*_clusters_price.png` и `*_clusters_scatter.png`.

## Тестирование

Перед публикацией необходимо прогнать хотя бы один сценарий:

```bash
python cli.py --tickers IMOEX --outer-folds 3 --test-horizon 120
python tools/build_report.py
```

Скрипт записывает все метрики в `outputs/metrics.csv`, а полные таблицы — в `outputs/consolidated/`. Если меняли расчёт признаков или модели, дополнительно выполните `python tools/run_imoex_analysis.py` для пересоздания цепного анализа.

## Данные

- Период: 2023‑10‑30 — 2025‑04‑03, шаг 1 час (ограничено наличием Brent/USD).
- Источники: MOEX ISS API (IMOEX), Yahoo Finance (Brent и USD/RUB).
- Все данные хранятся в UTC; индикаторы и лаги рассчитываются строго до момента $t$ (без look-ahead).
